#!/bin/bash
VERSION="0.2"
SUPPORTED_LANGUAGES=(php ruby)
GO_URL="https://storage.googleapis.com/golang"
# Misc
DATE_FORMAT='%H:%M %d/%m/%Y'

install::check_precompiled() {

  return $(curl -H "Host: packages.rt.com" --write-out %{http_code} --head --silent --output /dev/null http://138.201.33.90/${language}/${language_version}.tar.gz)
}

install::dl_precompiled() {

  curl -H "Host: packages.rt.com" --silent http://138.201.33.90/${language}/${language_version}.tar.gz --output ${language_version}.tar.gz
}

install::install_ruby() {
  if [[ $(install::check_precompiled) -ne 200 ]] ; then
    rbenv install -s ${language_version}
  else
    install::dl_precompiled
    tar -zxf ${language_version}.tar.gz
    mv ${language_version} ~/.rbenv/versions/
  fi
    rbenv rehash

  return $?
}

install::install_php() {
  if [[ $(install::check_precompiled) -ne 200 ]] ; then
    phpbrew install -j 4 ${language_version} +default +dbs +openssl -- --with-curl=/usr/local
    echo "date.timezone = UTC" >> "~/.phpbrew/php/php-${language_version}/etc/php.ini"
    phpbrew ext install imap -- --with-kerberos --with-imap-ssl
    phpbrew ext install gd -- --enable-gd-native-ttf --with-freetype-dir=/usr/lib/x86_64-linux-gnu
  else
    install::dl_precompiled
    tar -zxf ${language_version}.tar.gz 
    mv php-${language_version} ~/.phpbrew/php/
  fi

  return $?
}

install::usage() {
  echo -e "
################################################################################
sem-install ${VERSION} | Utility to install a selected languages version and activate it

Usage:
  sem-install language version
################################################################################"
}

install::log() {
  echo -e "\n[$(version::date)]: $@" >&2
}

install::err() {
  echo -e "\n! [$(version::date)]: $@" >&2

  return 1
}

install::main() {
  if ! [[ $# -eq 2 ]]; then
    install::usage
    install::err "Unsupported number of arguments provided!"

    return $?
  fi

  language=$1
  language_version=$2

  case $language in
    php)
      install::install_php 
      ;;
    ruby)
      install::install_ruby 
      ;;
    *)
      install:err "Language '${language}' install not supported yet."
      return 1;
      ;;
  esac
}

sem-install() {
  install::main "$@"
}


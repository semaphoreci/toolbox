#!/usr/bin/env bash

set -eo pipefail
IFS=$'\n\t'

DIST=$(uname)

cat << EOF >> ~/.ssh/config
Host github.com bitbucket.org
  StrictHostKeyChecking no
  UserKnownHostsFile=/dev/null
EOF

install_toolbox() {
  ln -sf ~/.toolbox/retry $INSTALL_PATH/retry
  chmod +x $INSTALL_PATH/retry

  ln -sf ~/.toolbox/ssh-session-cli $INSTALL_PATH/semaphore
  chmod +x $INSTALL_PATH/semaphore

  ln -sf ~/.toolbox/cache $INSTALL_PATH/cache
  chmod +x $INSTALL_PATH/cache

  ln -sf ~/.toolbox/sem-service $INSTALL_PATH/sem-service
  chmod +x $INSTALL_PATH/sem-service
}

install_artifacts() {
  case $DIST in
    Linux)
      ARTIFCAT_RELEASE=$(curl -s "https://api.github.com/repos/semaphoreci/artifact/releases/latest" | grep "browser_download_url" | grep $DIST | cut -d : -f 2,3 | tr -d '"' | tr -d " ")
      curl -s -L --retry 5 -o artifact.tar.gz $ARTIFCAT_RELEASE
      tar xzf artifact.tar.gz
      mv artifact $INSTALL_PATH/artifact
      chmod +x $INSTALL_PATH/artifact
      rm -f artifact.tar.gz LICENSE README.md
      ;;
    *)
      echo ""
      ;;
  esac
}

if [ `whoami` == 'root' ]; then
  INSTALL_PATH="/usr/bin"
else
  INSTALL_PATH="$HOME/.semaphoreci_bin"
  mkdir -p $INSTALL_PATH
  echo "export PATH=\"\$PATH:$INSTALL_PATH\"" >> ~/.semaphoreci_profile
fi

install_toolbox
install_artifacts

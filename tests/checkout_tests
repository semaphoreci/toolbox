set -e

. libcheckout

echo "Testing checkout..."

echo "Test checkout #1: without environment variables returns error"

! checkout

echo "Test checkout #2: clones the repo with variables set"

rm -rf /tmp/repo
SEMAPHORE_GIT_URL=https://github.com/mojombo/grit.git \
SEMAPHORE_GIT_BRANCH=master \
SEMAPHORE_GIT_DIR=/tmp/repo \
SEMAPHORE_GIT_SHA=5608567 \
checkout
echo "Checking created dir..."
cd /tmp/repo
echo "Checking git repo..."
git status
echo "Checking git branch..."
git branch | grep master
cd $base_dir

echo "Test checkout #3: Full clone with variable set"

rm -rf /tmp/repo
set +e
SEMAPHORE_GIT_URL=https://github.com/mojombo/grit.git \
SEMAPHORE_GIT_BRANCH=patch-id \
SEMAPHORE_GIT_DIR=/tmp/repo \
SEMAPHORE_GIT_SHA=aa0e169 \
checkout
set -e
echo "Checking created dir..."
cd /tmp/repo
echo "Checking git repo..."
git status
echo "Checking git branch..."
git branch | grep patch-id
git rev-parse HEAD | grep aa0e169

echo "Test checkout #4: Full clone with variable set old revision"
cd $base_dir
rm -rf /tmp/repo
set +e
SEMAPHORE_GIT_URL=https://github.com/mojombo/grit.git \
SEMAPHORE_GIT_BRANCH=patch-id \
SEMAPHORE_GIT_DIR=/tmp/repo \
SEMAPHORE_GIT_SHA=da70719 \
checkout
set -e
echo "Checking created dir..."
cd /tmp/repo
echo "Checking git repo..."
git status
echo "Checking git branch..."
git branch | grep patch-id
git rev-parse HEAD | grep da70719

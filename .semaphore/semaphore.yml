version: v1.0
name: Toolbox S2 project
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Run Tests
    task:
      prologue:
        commands:
          - checkout
          - cd ../
          - rm -rf .toolbox/
          - mv toolbox/ .toolbox
          - bash .toolbox/install-toolbox
          - source .toolbox/toolbox
          - cd .toolbox
      jobs:

      - name: MySQL
        commands:
          - sem-service start mysql
          - mysql --host=0.0.0.0 -uroot -e "create database fooo"
          - mysql --host=0.0.0.0 -uroot -e "show databases" | grep fooo
          - mysql --host=0.0.0.0 -uroot -e 'SHOW VARIABLES like "version";' | grep 5.6
          - sem-service status mysql
          - sem-service stop mysql
          - sem-service start mysql 5.7
          - mysql --host=0.0.0.0 -uroot -e "create database fooo"
          - mysql --host=0.0.0.0 -uroot -e "show databases" | grep fooo
          - mysql --host=0.0.0.0 -uroot -e 'SHOW VARIABLES like "version";' | grep 5.7
          - sem-service status mysql
          - sem-service stop mysql
          - sem-service start mysql 5.7 --username=test --password=test --db=fooo
          - mysql --host=0.0.0.0 -utest -ptest -e "show databases" | grep fooo
          - mysql --host=0.0.0.0 -utest -ptest -e "show databases" 
          - mysql --host=0.0.0.0 -utest -ptest -e 'SHOW VARIABLES like "version";' | grep 5.7
          - sem-service status mysql

      - name: PostgreSQL
        commands:
          - sem-service start postgres
          - createdb -U postgres -h 0.0.0.0 fooo
          - psql -h 0.0.0.0 -U postgres -c "\l" | grep fooo
          - psql -h 0.0.0.0 -U postgres -c "SELECT version()" | grep 9.6
          - sem-service status postgres
          - sem-service stop postgres
          - sem-service start postgres 11
          - createdb -U postgres -h 0.0.0.0 fooo
          - psql -h 0.0.0.0 -U postgres -c "\l" | grep fooo
          - psql -h 0.0.0.0 -U postgres -c "SELECT version()" | grep 11
          - sem-service status postgres


version: v1.0
name: Toolbox S2 project
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Run Tests
    task:
      prologue:
        commands:
          - checkout
          - cd ../
          - rm -rf .toolbox/
          - mv toolbox/ .toolbox
          - bash .toolbox/install-toolbox
          - source .toolbox/toolbox
          - cd .toolbox
      jobs:

      - name: MySQL
        commands:
          - sem-service start mysql 8.0.19 --username=test --password=test --garbage else
          - mysql  -utest -ptest -e "show databases" 
          - mysql  -utest -ptest -e 'SHOW VARIABLES like "version";' 
          - sem-service status mysql



      - name: PostgreSQL
        commands:
          - sem-service start postgres
          - createdb -U postgres -h 0.0.0.0 fooo
          - psql -h 0.0.0.0 -U postgres -c "\l" | grep fooo
          - psql -h 0.0.0.0 -U postgres -c "SELECT version()" | grep 9.6
          - sem-service status postgres
          - sem-service stop postgres
          - sem-service start postgres 11
          - createdb -U postgres -h 0.0.0.0 fooo
          - psql -h 0.0.0.0 -U postgres -c "\l" | grep fooo
          - psql  -U postgres -c "SELECT version()" | grep 11
          - sem-service status postgres
          - sem-service stop postgres
          - sem-service start postgres 11 --username=xxx --password=xxx --db=xxx --garbage else
          - createdb -U xxx  -h 0.0.0.0 fooo
          - psql -h 0.0.0.0 -U xxx -c "\l" 
          - psql -U xxx -c "SELECT version()" | grep 11
          - sem-service status postgres

      - name: Redis
        commands:
          - sem-service start redis
          - sem-service status redis
          - sem-service stop redis
          - sem-service start redis 5
          - sem-service status redis

      - name: mongodb
        commands:
          - sudo apt-get install -y mongodb-clients
          - sem-service start mongodb
          - curl http://localhost:27017 | grep "It looks like you are trying to access MongoDB over HTTP on the native driver port."
          - sem-service status mongodb
          - sem-service stop mongodb
          - sem-service start mongodb 3.2
          - curl http://localhost:27017 | grep "It looks like you are trying to access MongoDB over HTTP on the native driver port."
          - sem-service status mongodb
          - sem-service stop mongodb
          - sem-service start mongodb 4.2 --username=xxx --password=xxx
          - echo "show dbs" | mongo -u "xxx" -p "xxx" 127.0.0.1  --authenticationDatabase "admin"
